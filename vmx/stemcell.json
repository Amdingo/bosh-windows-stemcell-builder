{
  "variables": {
    "source_path": null,
    "administrator_password": null,
    "output_directory": null
  },
  "builders": [
    {
      "type": "vmware-vmx",

      "source_path": "{{user `source_path`}}",

      "headless": false,
      "boot_wait": "2m",

      "shutdown_command": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -File C:\\sysprep.ps1 -NewPassword {{user `administrator_password`}}",
      "shutdown_timeout": "1h",

      "communicator": "winrm",
      "ssh_username": "Administrator",
      "winrm_username": "Administrator",
      "winrm_password": "{{user `administrator_password`}}",
      "winrm_timeout": "2m",
      "winrm_insecure": true,

      "vmx_data": {
        "memsize": "4096",
        "numvcpus": "4"
      },

      "output_directory": "{{user `output_directory`}}"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "../../compiled-agent/agent.zip",
      "destination": "C:\\bosh\\agent.zip"
    },
    {
      "type": "file",
      "source": "../../compiled-agent/agent-dependencies.zip",
      "destination": "C:\\bosh\\agent-dependencies.zip"
    },
    {
      "type": "file",
      "source": "policy-baseline.zip",
      "destination": "C:\\policy-baseline.zip"
    },
    {
      "type": "file",
      "source": "../../windows-stemcell-dependencies/lgpo/LGPO.exe",
      "destination": "C:\\LGPO.exe"
    },
    {
      "type": "file",
      "source": "../vsphere/scripts/sysprep.ps1",
      "destination": "C:\\sysprep.ps1"
    },
    {
      "type": "windows-shell",
      "scripts": ["../vsphere/scripts/enable-rdp.bat"]
    },
    {
      "type": "powershell",
      "scripts": [
        "../vsphere/scripts/add-vcap-group.ps1",
        "scripts/run-policies.ps1",
        "../scripts/setup_agent.ps1",
        "../vsphere/scripts/agent_config.ps1",
        "../scripts/disable-services.ps1",
        "../scripts/set-firewall.ps1",
        "../vsphere/scripts/cleanup-temp-directories.ps1",
        "../scripts/cleanup-artifacts.ps1"
      ]
    }
  ]
}
