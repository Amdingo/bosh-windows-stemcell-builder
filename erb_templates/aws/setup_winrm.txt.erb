<powershell>
Remove-Item -Path WSMan:\Localhost\listener\listener* -Recurse
Remove-Item Cert:\LocalMachine\My\*

$certContentsBase64 = @"
<%= @cert %>
"@

$certBinaryContents = [System.Convert]::FromBase64String($certContentsBase64)

$tmp = "$env:TMP/cert.p12"
Set-Content -Encoding Byte -Path $tmp -Value $certBinaryContents
Import-PfxCertificate -FilePath $tmp -CertStoreLocation Cert:\LocalMachine\My

$Cert = (Get-ChildItem Cert:\LocalMachine\My)[0]
New-Item -Path WSMan:\LocalHost\Listener -Transport HTTPS -Address * -CertificateThumbPrint $Cert.Thumbprint -Force

winrm quickconfig -q
winrm set winrm/config/winrs '@{MaxMemoryPerShellMB="300"}'
winrm set winrm/config '@{MaxTimeoutms="1800000"}'
winrm set winrm/config/service '@{AllowUnencrypted="false"}'
winrm set winrm/config/service/auth '@{Basic="true"}'
winrm set winrm/config/listener?Address=*+Transport=HTTPS "@{Port=`"5986`";Hostname=`"packer`";CertificateThumbprint=`"$($Cert.Thumbprint)`"}"

netsh advfirewall firewall add rule name="WinRM 5986" protocol=TCP dir=in localport=5986 action=allow

net stop winrm
net start winrm

Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope LocalMachine
</powershell>
